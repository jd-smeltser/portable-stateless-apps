<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0a">
  <title>Calendar</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --border: #262626;
      --border-light: #333;
      --text: #e5e5e5;
      --text-muted: #737373;
      --accent: #3b82f6;
      --accent-dim: #1e40af;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    #app {
      display: flex;
      height: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .new-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1.25rem;
      cursor: pointer;
    }

    .new-btn:hover { background: var(--border); }

    /* Date nav */
    .date-nav {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .date-nav-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
      font-size: 1rem;
    }

    .date-nav-btn:hover { background: var(--border); }

    .date-display {
      flex: 1;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .today-btn {
      padding: 6px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .today-btn:hover { background: var(--border); }

    /* Events list */
    .events-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .section-label {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 12px 12px 6px;
    }

    .event-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      border-left: 3px solid var(--accent);
      background: var(--surface);
    }

    .event-item:hover { background: var(--border); }
    .event-item.active { border-color: #22c55e; }

    .event-item-time {
      font-size: 0.7rem;
      color: var(--accent);
      font-weight: 500;
      margin-bottom: 2px;
    }

    .event-item-title {
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Calendar grid */
    .calendar {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .calendar-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .calendar-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .calendar-grid {
      flex: 1;
      overflow-y: auto;
      position: relative;
    }

    .time-grid {
      position: relative;
      min-height: 100%;
    }

    .time-slot {
      height: 60px;
      border-bottom: 1px solid var(--border);
      display: flex;
      position: relative;
    }

    .time-slot:nth-child(even) {
      border-bottom-style: dashed;
      border-bottom-color: #1a1a1a;
    }

    .time-label {
      width: 60px;
      padding: 4px 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: right;
      flex-shrink: 0;
    }

    .time-content {
      flex: 1;
      position: relative;
      border-left: 1px solid var(--border);
    }

    .time-content:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    /* Events on grid */
    .grid-event {
      position: absolute;
      left: 4px;
      right: 4px;
      background: var(--accent-dim);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      overflow: hidden;
      z-index: 10;
      transition: all 0.15s;
    }

    .grid-event:hover {
      background: var(--accent);
    }

    .grid-event-title {
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .grid-event-time {
      font-size: 0.65rem;
      opacity: 0.8;
    }

    /* Current time indicator */
    .current-time {
      position: absolute;
      left: 60px;
      right: 0;
      height: 2px;
      background: #ef4444;
      z-index: 20;
    }

    .current-time::before {
      content: '';
      position: absolute;
      left: -4px;
      top: -4px;
      width: 10px;
      height: 10px;
      background: #ef4444;
      border-radius: 50%;
    }

    /* Editor panel */
    .editor {
      width: 350px;
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .editor.hidden { display: none; }

    .editor-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .editor-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .editor-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.25rem;
      cursor: pointer;
    }

    .editor-close:hover { color: var(--text); }

    .editor-content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .field {
      margin-bottom: 16px;
    }

    .field-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .field input, .field textarea, .field select {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      font-family: inherit;
    }

    .field input:focus, .field textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .field textarea {
      min-height: 100px;
      resize: vertical;
    }

    .time-inputs {
      display: flex;
      gap: 8px;
    }

    .time-inputs input {
      flex: 1;
    }

    .editor-actions {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      flex: 1;
    }

    .btn:hover { background: var(--border); }
    .btn.primary { background: var(--accent); border-color: var(--accent); }
    .btn.danger { color: #ef4444; }

    /* Links panel */
    .links-panel {
      border-top: 1px solid var(--border);
      padding: 12px;
      margin-top: 8px;
    }

    .links-panel.empty { display: none; }

    .links-label {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .links-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .link-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .link-chip:hover { border-color: var(--accent); }

    /* Status toast */
    .status {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 500;
    }

    .status.visible { opacity: 1; }

    .empty-state {
      padding: 24px 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* Mobile */
    @media (max-width: 900px) {
      .sidebar {
        position: fixed;
        left: 0; top: 0; bottom: 0;
        width: 280px;
        background: var(--bg);
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.2s;
      }
      .sidebar.open { transform: translateX(0); }
      .editor { width: 100%; position: fixed; right: 0; top: 0; bottom: 0; background: var(--bg); z-index: 100; }
    }
  </style>
</head>
<body>
  <div id="app">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="logo">Calendar</span>
        <button class="new-btn" id="new-btn" title="New event">+</button>
      </div>
      <div class="date-nav">
        <button class="date-nav-btn" id="prev-day">&lt;</button>
        <span class="date-display" id="date-display">Today</span>
        <button class="date-nav-btn" id="next-day">&gt;</button>
        <button class="today-btn" id="today-btn">Today</button>
      </div>
      <div class="events-list" id="events-list"></div>
    </aside>

    <main class="calendar">
      <div class="calendar-header">
        <span class="calendar-title" id="calendar-title">Today's Schedule</span>
      </div>
      <div class="calendar-grid" id="calendar-grid">
        <div class="time-grid" id="time-grid"></div>
      </div>
    </main>

    <aside class="editor hidden" id="editor">
      <div class="editor-header">
        <span class="editor-title">Event</span>
        <button class="editor-close" id="editor-close">&times;</button>
      </div>
      <div class="editor-content">
        <div class="field">
          <div class="field-label">Title</div>
          <input type="text" id="event-title" placeholder="Event title">
        </div>
        <div class="field">
          <div class="field-label">Time</div>
          <div class="time-inputs">
            <input type="time" id="event-start">
            <input type="time" id="event-end">
          </div>
        </div>
        <div class="field">
          <div class="field-label">Duration</div>
          <select id="event-duration">
            <option value="15">15 min</option>
            <option value="30" selected>30 min</option>
            <option value="45">45 min</option>
            <option value="60">1 hour</option>
            <option value="90">1.5 hours</option>
            <option value="120">2 hours</option>
          </select>
        </div>
        <div class="field">
          <div class="field-label">Notes</div>
          <textarea id="event-body" placeholder="Add notes or use @ to link..."></textarea>
        </div>
        <div class="links-panel empty" id="links-panel">
          <div class="links-label">LINKED</div>
          <div class="links-list" id="links-list"></div>
        </div>
      </div>
      <div class="editor-actions">
        <button class="btn danger" id="delete-btn">Delete</button>
        <button class="btn primary" id="save-btn">Save</button>
      </div>
    </aside>

    <div class="status" id="status"></div>
  </div>

  <script src="https://unpkg.com/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <script type="module">
    import Registry from '../../core/registry.js';
    import Linker from '../../core/linker.js';
    import Omnibar from '../../core/omnibar.js';

    // ============================================
    // State
    // ============================================

    let currentDate = new Date();
    let currentEventId = null;
    const DAY_START = 6; // 6 AM
    const DAY_END = 22;  // 10 PM

    // ============================================
    // Elements
    // ============================================

    const dateDisplay = document.getElementById('date-display');
    const calendarTitle = document.getElementById('calendar-title');
    const timeGrid = document.getElementById('time-grid');
    const eventsList = document.getElementById('events-list');
    const editor = document.getElementById('editor');
    const titleInput = document.getElementById('event-title');
    const startInput = document.getElementById('event-start');
    const endInput = document.getElementById('event-end');
    const durationSelect = document.getElementById('event-duration');
    const bodyInput = document.getElementById('event-body');
    const linksPanel = document.getElementById('links-panel');
    const linksList = document.getElementById('links-list');
    const statusEl = document.getElementById('status');

    // ============================================
    // URL Encoding
    // ============================================

    function encodeState(state) {
      return LZString.compressToEncodedURIComponent(JSON.stringify(state));
    }

    function decodeState(hash) {
      try {
        return JSON.parse(LZString.decompressFromEncodedURIComponent(hash));
      } catch (e) {
        return null;
      }
    }

    function getStateFromURL(url) {
      const hash = url.split('#')[1];
      return hash ? decodeState(hash) : null;
    }

    // ============================================
    // Date Utilities
    // ============================================

    function formatDateDisplay(date) {
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (isSameDay(date, today)) return 'Today';
      if (isSameDay(date, tomorrow)) return 'Tomorrow';
      if (isSameDay(date, yesterday)) return 'Yesterday';

      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }

    function getDateKey(date) {
      return date.toISOString().split('T')[0];
    }

    function formatTime(date) {
      return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    }

    function formatTimeShort(date) {
      return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }).toLowerCase();
    }

    function timeToMinutes(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    function minutesToTime(minutes) {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    // ============================================
    // Event Operations
    // ============================================

    function getEventsForDate(date) {
      const dateKey = getDateKey(date);
      return Registry.byType('event').filter(e => {
        const state = getStateFromURL(e.url);
        if (!state?.start) return false;
        const eventDate = new Date(state.start);
        return getDateKey(eventDate) === dateKey;
      }).sort((a, b) => {
        const stateA = getStateFromURL(a.url);
        const stateB = getStateFromURL(b.url);
        return (stateA?.start || 0) - (stateB?.start || 0);
      });
    }

    function createEvent(startTime = null, title = '') {
      const ts = Date.now();

      // Default to next hour if no time specified
      if (!startTime) {
        startTime = new Date(currentDate);
        const now = new Date();
        startTime.setHours(now.getHours() + 1, 0, 0, 0);
      }

      const state = {
        t: title,
        b: '',
        start: startTime.getTime(),
        duration: 30,
        ts
      };

      const url = window.location.pathname + '#' + encodeState(state);
      const record = Registry.add('event', url, {
        meta: { title: title || 'New Event', ts, start: state.start, duration: state.duration }
      });

      currentEventId = record.id;
      openEditor(record);
      renderAll();
    }

    function selectEvent(id) {
      const record = Registry.get(id);
      if (!record) return;
      currentEventId = id;
      openEditor(record);
      renderEventsList();
    }

    function saveEvent() {
      if (!currentEventId) return;

      const record = Registry.get(currentEventId);
      const existingState = getStateFromURL(record?.url);
      const ts = existingState?.ts || record?.meta?.ts || Date.now();

      // Parse time inputs
      const startMinutes = timeToMinutes(startInput.value);
      const startDate = new Date(currentDate);
      startDate.setHours(Math.floor(startMinutes / 60), startMinutes % 60, 0, 0);

      const duration = parseInt(durationSelect.value);

      const state = {
        t: titleInput.value,
        b: bodyInput.value,
        start: startDate.getTime(),
        duration,
        ts
      };

      const url = window.location.pathname + '#' + encodeState(state);
      const linkIds = Linker.extractLinkIds(bodyInput.value);

      Registry.update(currentEventId, {
        url,
        links: linkIds,
        meta: {
          title: titleInput.value || 'Untitled Event',
          ts,
          start: state.start,
          duration
        }
      });

      showStatus('Event saved');
      renderAll();
    }

    function deleteEvent() {
      if (!currentEventId) return;
      Registry.remove(currentEventId);
      closeEditor();
      renderAll();
      showStatus('Event deleted');
    }

    // ============================================
    // Editor
    // ============================================

    function openEditor(record) {
      const state = getStateFromURL(record.url);

      titleInput.value = state?.t || '';
      bodyInput.value = state?.b || '';

      if (state?.start) {
        const startDate = new Date(state.start);
        startInput.value = minutesToTime(startDate.getHours() * 60 + startDate.getMinutes());

        const duration = state.duration || 30;
        durationSelect.value = duration;

        const endMinutes = startDate.getHours() * 60 + startDate.getMinutes() + duration;
        endInput.value = minutesToTime(endMinutes);
      }

      editor.classList.remove('hidden');
      titleInput.focus();
      renderLinks();
      updateLinkerContext();
    }

    function closeEditor() {
      editor.classList.add('hidden');
      currentEventId = null;
      renderEventsList();
    }

    // Update end time when start or duration changes
    startInput.addEventListener('change', () => {
      const startMinutes = timeToMinutes(startInput.value);
      const duration = parseInt(durationSelect.value);
      endInput.value = minutesToTime(startMinutes + duration);
    });

    durationSelect.addEventListener('change', () => {
      const startMinutes = timeToMinutes(startInput.value);
      const duration = parseInt(durationSelect.value);
      endInput.value = minutesToTime(startMinutes + duration);
    });

    // ============================================
    // Links Panel
    // ============================================

    function renderLinks() {
      if (!currentEventId) {
        linksPanel.classList.add('empty');
        return;
      }

      const record = Registry.get(currentEventId);
      if (!record) {
        linksPanel.classList.add('empty');
        return;
      }

      const outgoing = (record.links || []).map(id => Registry.get(id)).filter(Boolean);
      const incoming = Registry.linkedTo(currentEventId);
      const all = [...outgoing, ...incoming.filter(r => !outgoing.find(o => o.id === r.id))];

      if (all.length === 0) {
        linksPanel.classList.add('empty');
        return;
      }

      linksPanel.classList.remove('empty');
      linksList.innerHTML = all.map(r => {
        const state = getStateFromURL(r.url);
        const title = state?.t || r.meta?.title || 'Untitled';
        const icon = r.type === 'note' ? 'üìù' :
                     r.type === 'task' ? '‚òëÔ∏è' :
                     r.type === 'event' ? 'üìÖ' :
                     r.type === 'template' ? 'üìÑ' : 'üìé';
        return `<span class="link-chip" data-id="${r.id}" data-type="${r.type}">${icon} ${escapeHtml(title)}</span>`;
      }).join('');
    }

    linksList.addEventListener('click', (e) => {
      const chip = e.target.closest('.link-chip');
      if (chip) {
        navigateToLink(chip.dataset.id, chip.dataset.type);
      }
    });

    function navigateToLink(id, type) {
      const record = Registry.get(id);
      if (!record) return;

      if (type === 'event') {
        selectEvent(id);
      } else if (type === 'note') {
        const hash = record.url.split('#')[1];
        window.location.href = '../note/' + (hash ? '#' + hash : '');
      } else if (type === 'task') {
        const hash = record.url.split('#')[1];
        window.location.href = '../tasks/' + (hash ? '#' + hash : '');
      }
    }

    // ============================================
    // Linker
    // ============================================

    let linkerState = null;

    function updateLinkerContext() {
      if (linkerState) {
        linkerState.options.recordId = currentEventId;
        linkerState.options.excludeId = currentEventId;
      }
    }

    // ============================================
    // Rendering
    // ============================================

    function renderAll() {
      renderDateDisplay();
      renderTimeGrid();
      renderEventsList();
    }

    function renderDateDisplay() {
      dateDisplay.textContent = formatDateDisplay(currentDate);
      calendarTitle.textContent = formatDateDisplay(currentDate) + "'s Schedule";
    }

    function renderTimeGrid() {
      const events = getEventsForDate(currentDate);
      let html = '';

      // Generate time slots
      for (let hour = DAY_START; hour <= DAY_END; hour++) {
        const timeLabel = new Date(2000, 0, 1, hour, 0).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
        html += `
          <div class="time-slot" data-hour="${hour}">
            <div class="time-label">${timeLabel}</div>
            <div class="time-content" data-hour="${hour}"></div>
          </div>
        `;
      }

      timeGrid.innerHTML = html;

      // Add events to grid
      events.forEach(event => {
        const state = getStateFromURL(event.url);
        if (!state?.start) return;

        const startDate = new Date(state.start);
        const startHour = startDate.getHours();
        const startMinute = startDate.getMinutes();
        const duration = state.duration || 30;

        if (startHour < DAY_START || startHour > DAY_END) return;

        const topOffset = (startHour - DAY_START) * 60 + startMinute;
        const height = Math.min(duration, (DAY_END - startHour + 1) * 60 - startMinute);

        const eventEl = document.createElement('div');
        eventEl.className = 'grid-event';
        eventEl.dataset.id = event.id;
        eventEl.style.top = topOffset + 'px';
        eventEl.style.height = Math.max(height, 20) + 'px';
        eventEl.innerHTML = `
          <div class="grid-event-title">${escapeHtml(state.t || 'Untitled')}</div>
          ${height >= 30 ? `<div class="grid-event-time">${formatTimeShort(startDate)}</div>` : ''}
        `;

        const container = timeGrid.querySelector('.time-content');
        if (container) {
          container.appendChild(eventEl);
        }
      });

      // Add current time indicator if viewing today
      if (isSameDay(currentDate, new Date())) {
        const now = new Date();
        const nowHour = now.getHours();
        const nowMinute = now.getMinutes();

        if (nowHour >= DAY_START && nowHour <= DAY_END) {
          const topOffset = (nowHour - DAY_START) * 60 + nowMinute;
          const indicator = document.createElement('div');
          indicator.className = 'current-time';
          indicator.style.top = topOffset + 'px';
          timeGrid.appendChild(indicator);
        }
      }
    }

    function renderEventsList() {
      const events = getEventsForDate(currentDate);

      if (events.length === 0) {
        eventsList.innerHTML = '<div class="empty-state">No events<br>Click + to add one</div>';
        return;
      }

      eventsList.innerHTML = '<div class="section-label">EVENTS</div>' + events.map(event => {
        const state = getStateFromURL(event.url);
        const startDate = state?.start ? new Date(state.start) : null;
        const isActive = event.id === currentEventId;

        return `
          <div class="event-item ${isActive ? 'active' : ''}" data-id="${event.id}">
            <div class="event-item-time">${startDate ? formatTimeShort(startDate) : ''}</div>
            <div class="event-item-title">${escapeHtml(state?.t || 'Untitled')}</div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function showStatus(msg) {
      statusEl.textContent = msg;
      statusEl.classList.add('visible');
      setTimeout(() => statusEl.classList.remove('visible'), 1500);
    }

    // ============================================
    // Event Listeners
    // ============================================

    document.getElementById('new-btn').addEventListener('click', () => createEvent());
    document.getElementById('prev-day').addEventListener('click', () => {
      currentDate.setDate(currentDate.getDate() - 1);
      closeEditor();
      renderAll();
    });
    document.getElementById('next-day').addEventListener('click', () => {
      currentDate.setDate(currentDate.getDate() + 1);
      closeEditor();
      renderAll();
    });
    document.getElementById('today-btn').addEventListener('click', () => {
      currentDate = new Date();
      closeEditor();
      renderAll();
    });

    document.getElementById('editor-close').addEventListener('click', closeEditor);
    document.getElementById('save-btn').addEventListener('click', saveEvent);
    document.getElementById('delete-btn').addEventListener('click', deleteEvent);

    // Click on time grid to create event
    timeGrid.addEventListener('click', (e) => {
      const gridEvent = e.target.closest('.grid-event');
      if (gridEvent) {
        selectEvent(gridEvent.dataset.id);
        return;
      }

      const timeContent = e.target.closest('.time-content');
      if (timeContent) {
        const hour = parseInt(timeContent.dataset.hour);
        const rect = timeContent.getBoundingClientRect();
        const clickY = e.clientY - rect.top;
        const minute = Math.floor(clickY / 60 * 60 / 15) * 15; // Snap to 15 min

        const startTime = new Date(currentDate);
        startTime.setHours(hour, minute, 0, 0);
        createEvent(startTime);
      }
    });

    // Click on events list
    eventsList.addEventListener('click', (e) => {
      const item = e.target.closest('.event-item');
      if (item) {
        selectEvent(item.dataset.id);
      }
    });

    // Auto-save on input
    let saveTimeout;
    const autoSave = () => {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveEvent, 500);
    };

    titleInput.addEventListener('input', autoSave);
    bodyInput.addEventListener('input', autoSave);
    startInput.addEventListener('change', autoSave);
    durationSelect.addEventListener('change', autoSave);

    Registry.subscribe(() => renderAll());

    // ============================================
    // Init
    // ============================================

    function init() {
      // Init omnibar (nvalt-style search/create)
      Omnibar.init({
        app: 'calendar',
        onCreate: (title) => createEvent(null, title),
        onSelect: (record) => {
          if (record.type === 'event') {
            // Navigate to event's date
            const state = getStateFromURL(record.url);
            if (state?.start) {
              currentDate = new Date(state.start);
            }
            selectEvent(record.id);
            return true;
          }
          return false;
        }
      });

      Linker.init();
      linkerState = Linker.attach(bodyInput, {
        recordId: null,
        excludeId: null
      });

      // Check for spawn parameter
      const urlParams = new URLSearchParams(window.location.search);
      const spawnId = urlParams.get('spawn');
      if (spawnId) {
        history.replaceState(null, '', window.location.pathname);
        // Handle spawning from template if needed
      }

      // Check for URL hash to load a specific event
      const hash = window.location.hash.slice(1);
      if (hash) {
        const state = decodeState(hash);
        if (state && state.ts) {
          // Find existing event by timestamp
          const events = Registry.byType('event');
          const existing = events.find(e => e.meta?.ts === state.ts);

          if (existing) {
            // Navigate to that event's date and open it
            if (state.start) {
              currentDate = new Date(state.start);
            }
            currentEventId = existing.id;
            renderAll();
            openEditor(existing);
            updateLinkerContext();
            return;
          } else {
            // Create new event from URL
            const ts = state.ts;
            const url = window.location.href;
            const record = Registry.add('event', url, {
              meta: {
                title: state.t || 'Untitled Event',
                ts,
                start: state.start,
                duration: state.duration || 30
              }
            });
            if (state.start) {
              currentDate = new Date(state.start);
            }
            currentEventId = record.id;
            renderAll();
            openEditor(record);
            updateLinkerContext();
            return;
          }
        }
      }

      renderAll();

      // Update current time indicator every minute
      setInterval(() => {
        if (isSameDay(currentDate, new Date())) {
          renderTimeGrid();
        }
      }, 60000);
    }

    init();
  </script>
</body>
</html>
