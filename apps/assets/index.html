<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0a">
  <title>Assets</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --border: #262626;
      --text: #e5e5e5;
      --text-muted: #737373;
      --accent: #3b82f6;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    #app {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
      padding-top: calc(env(safe-area-inset-top) + 24px);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover { background: var(--border); }
    .btn.primary { background: var(--accent); border-color: var(--accent); }
    .btn.danger { color: var(--danger); }
    .btn.danger:hover { background: rgba(239, 68, 68, 0.1); }

    .stats {
      display: flex;
      gap: 24px;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .assets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .asset-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .asset-card:hover {
      border-color: var(--accent);
    }

    .asset-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .asset-preview {
      height: 140px;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .asset-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .asset-preview .placeholder {
      color: var(--text-muted);
      font-size: 2rem;
    }

    .asset-info {
      padding: 12px;
    }

    .asset-name {
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .asset-meta {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state h2 {
      font-size: 1.1rem;
      margin-bottom: 8px;
      color: var(--text);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-backdrop.visible {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px;
    }

    .modal-close:hover { color: var(--text); }

    .modal-body {
      padding: 20px;
    }

    .modal-preview {
      text-align: center;
      margin-bottom: 20px;
    }

    .modal-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .detail-row:last-child { border-bottom: none; }

    .detail-label {
      color: var(--text-muted);
    }

    .detail-value {
      font-weight: 500;
    }

    .references-list {
      margin-top: 16px;
    }

    .references-list h3 {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .ref-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--bg);
      border-radius: 6px;
      font-size: 0.8rem;
      margin-right: 8px;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .ref-chip:hover {
      background: var(--border);
    }

    .modal-actions {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .copy-syntax {
      padding: 10px;
      background: var(--bg);
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.8rem;
      margin-top: 12px;
      word-break: break-all;
      cursor: pointer;
    }

    .copy-syntax:hover {
      background: var(--border);
    }

    /* Status toast */
    .status {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom) + 16px);
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 500;
    }

    .status.visible { opacity: 1; }

    /* Upload zone */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin-bottom: 24px;
      transition: all 0.2s;
    }

    .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.05);
    }

    .upload-zone p {
      color: var(--text-muted);
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Asset Manager</h1>
      <div class="header-actions">
        <button class="btn" id="import-btn">Import</button>
        <button class="btn" id="export-btn">Export All</button>
        <button class="btn primary" id="upload-btn">Upload</button>
        <input type="file" id="file-input" accept="image/*" multiple style="display:none">
      </div>
    </header>

    <div class="upload-zone" id="upload-zone">
      <p>Drag & drop images here or click Upload</p>
      <span style="font-size: 0.75rem; color: var(--text-muted);">Max 5MB per file</span>
    </div>

    <div class="stats" id="stats"></div>

    <div class="assets-grid" id="assets-grid"></div>

    <!-- Asset Detail Modal -->
    <div class="modal-backdrop" id="modal">
      <div class="modal">
        <div class="modal-header">
          <h2 id="modal-title">Asset Details</h2>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
        <div class="modal-actions">
          <button class="btn" id="copy-ref-btn">Copy Reference</button>
          <button class="btn danger" id="delete-btn">Delete</button>
        </div>
      </div>
    </div>

    <div class="status" id="status"></div>
  </div>

  <script src="https://unpkg.com/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <script type="module">
    import Registry from '../../core/registry.js';
    import Assets from '../../core/assets.js';
    import Omnibar from '../../core/omnibar.js';

    // ============================================
    // State
    // ============================================

    let selectedAssetId = null;

    // ============================================
    // Elements
    // ============================================

    const statsEl = document.getElementById('stats');
    const gridEl = document.getElementById('assets-grid');
    const modalEl = document.getElementById('modal');
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title');
    const statusEl = document.getElementById('status');
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');

    // ============================================
    // Rendering
    // ============================================

    function render() {
      const assets = Assets.all();
      renderStats(assets);
      renderGrid(assets);
    }

    function renderStats(assets) {
      const totalSize = assets.reduce((sum, a) => sum + (a.meta?.size || 0), 0);
      const referencedCount = assets.filter(a => getReferences(a.id).length > 0).length;

      statsEl.innerHTML = `
        <div class="stat">
          <div class="stat-value">${assets.length}</div>
          <div class="stat-label">Total Assets</div>
        </div>
        <div class="stat">
          <div class="stat-value">${formatSize(totalSize)}</div>
          <div class="stat-label">Storage Used</div>
        </div>
        <div class="stat">
          <div class="stat-value">${referencedCount}</div>
          <div class="stat-label">Referenced</div>
        </div>
        <div class="stat">
          <div class="stat-value">${assets.length - referencedCount}</div>
          <div class="stat-label">Orphaned</div>
        </div>
      `;
    }

    function renderGrid(assets) {
      if (assets.length === 0) {
        gridEl.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <h2>No assets yet</h2>
            <p>Upload images to get started</p>
          </div>
        `;
        return;
      }

      gridEl.innerHTML = assets.map(asset => {
        const dataUrl = Assets.getDataUrl(asset.id);
        const name = asset.meta?.name || 'Untitled';
        const size = formatSize(asset.meta?.size || 0);
        const date = formatDate(asset.meta?.ts);

        return `
          <div class="asset-card" data-id="${asset.id}">
            <div class="asset-preview">
              ${dataUrl ? `<img src="${dataUrl}" alt="${escapeHtml(name)}">` : '<span class="placeholder">?</span>'}
            </div>
            <div class="asset-info">
              <div class="asset-name">${escapeHtml(name)}</div>
              <div class="asset-meta">
                <span>${size}</span>
                <span>${date}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderModal(asset) {
      const dataUrl = Assets.getDataUrl(asset.id);
      const refs = getReferences(asset.id);

      modalTitle.textContent = asset.meta?.name || 'Asset Details';
      modalBody.innerHTML = `
        <div class="modal-preview">
          ${dataUrl ? `<img src="${dataUrl}" alt="">` : ''}
        </div>
        <div class="detail-row">
          <span class="detail-label">ID</span>
          <span class="detail-value">${asset.id}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Type</span>
          <span class="detail-value">${asset.meta?.mimeType || 'Unknown'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Size</span>
          <span class="detail-value">${formatSize(asset.meta?.size || 0)}</span>
        </div>
        ${asset.meta?.width ? `
        <div class="detail-row">
          <span class="detail-label">Dimensions</span>
          <span class="detail-value">${asset.meta.width} Ã— ${asset.meta.height}px</span>
        </div>
        ` : ''}
        <div class="detail-row">
          <span class="detail-label">Created</span>
          <span class="detail-value">${new Date(asset.meta?.ts).toLocaleString()}</span>
        </div>

        ${refs.length > 0 ? `
        <div class="references-list">
          <h3>Referenced by (${refs.length})</h3>
          ${refs.map(r => `
            <span class="ref-chip" data-type="${r.type}" data-id="${r.id}">
              ${getTypeIcon(r.type)} ${escapeHtml(r.meta?.title || 'Untitled')}
            </span>
          `).join('')}
        </div>
        ` : `
        <div class="references-list">
          <h3>Not referenced</h3>
          <p style="font-size: 0.8rem; color: var(--text-muted);">This asset is orphaned and can be safely deleted.</p>
        </div>
        `}

        <div class="copy-syntax" id="copy-syntax" title="Click to copy">
          ![${escapeHtml(asset.meta?.name || '')}](${asset.id})
        </div>
      `;
    }

    // ============================================
    // Helpers
    // ============================================

    function getReferences(assetId) {
      // Find all records that reference this asset
      const allRecords = Registry.all();
      return allRecords.filter(r => {
        if (r.type === 'asset') return false;
        // Check if the URL contains the asset reference
        try {
          const hash = r.url.split('#')[1];
          if (!hash) return false;
          const state = JSON.parse(LZString.decompressFromEncodedURIComponent(hash));
          const body = state?.b || '';
          return body.includes(`](${assetId})`);
        } catch {
          return false;
        }
      });
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function formatDate(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleDateString();
    }

    function getTypeIcon(type) {
      switch (type) {
        case 'note': return 'ðŸ“';
        case 'task': return 'â˜‘ï¸';
        case 'event': return 'ðŸ“…';
        default: return 'ðŸ“Ž';
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showStatus(message) {
      statusEl.textContent = message;
      statusEl.classList.add('visible');
      setTimeout(() => statusEl.classList.remove('visible'), 2000);
    }

    function showModal() {
      modalEl.classList.add('visible');
    }

    function hideModal() {
      modalEl.classList.remove('visible');
      selectedAssetId = null;
    }

    // ============================================
    // Actions
    // ============================================

    async function handleUpload(files) {
      let uploaded = 0;
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        try {
          await Assets.createFromFile(file);
          uploaded++;
        } catch (err) {
          showStatus(err.message);
        }
      }
      if (uploaded > 0) {
        showStatus(`Uploaded ${uploaded} asset${uploaded > 1 ? 's' : ''}`);
        render();
      }
    }

    function deleteAsset(id) {
      if (!confirm('Delete this asset? Any references will show as broken.')) return;
      Assets.remove(id);
      hideModal();
      render();
      showStatus('Asset deleted');
    }

    function copyReference(id) {
      const asset = Assets.get(id);
      if (!asset) return;
      const ref = `![${asset.meta?.name || ''}](${id})`;
      navigator.clipboard.writeText(ref)
        .then(() => showStatus('Reference copied!'))
        .catch(() => showStatus('Failed to copy'));
    }

    function exportAllAssets() {
      const assets = Assets.all();
      if (assets.length === 0) {
        showStatus('No assets to export');
        return;
      }

      // Create export bundle with full asset data
      const bundle = {
        version: 1,
        exported: new Date().toISOString(),
        assets: assets.map(a => ({
          id: a.id,
          data: a.url.replace('asset://', ''),
          meta: a.meta
        }))
      };

      const json = JSON.stringify(bundle);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `assets-export-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showStatus('Assets exported');
    }

    function importAssets() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const bundle = JSON.parse(text);

          if (!bundle.assets || !Array.isArray(bundle.assets)) {
            throw new Error('Invalid asset bundle');
          }

          let imported = 0;
          for (const asset of bundle.assets) {
            // Skip if already exists
            if (Assets.get(asset.id)) continue;
            // Import with original ID preserved
            const result = Assets.importWithId(asset.id, asset.data, asset.meta);
            if (result) imported++;
          }

          render();
          showStatus(`Imported ${imported} asset${imported !== 1 ? 's' : ''}`);
        } catch (err) {
          showStatus('Failed to import: ' + err.message);
        }
      };
      input.click();
    }

    function navigateToRecord(type, id) {
      const record = Registry.get(id);
      if (!record) return;

      const hash = record.url.split('#')[1];
      let path;
      switch (type) {
        case 'note': path = '../note/'; break;
        case 'task': path = '../tasks/'; break;
        case 'event': path = '../calendar/'; break;
        default: return;
      }
      window.location.href = path + (hash ? '#' + hash : '');
    }

    // ============================================
    // Event Listeners
    // ============================================

    // Upload button
    document.getElementById('upload-btn').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      handleUpload(e.target.files);
      fileInput.value = '';
    });

    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      handleUpload(e.dataTransfer.files);
    });

    // Grid clicks
    gridEl.addEventListener('click', (e) => {
      const card = e.target.closest('.asset-card');
      if (!card) return;

      selectedAssetId = card.dataset.id;
      const asset = Assets.get(selectedAssetId);
      if (asset) {
        renderModal(asset);
        showModal();
      }
    });

    // Modal
    document.getElementById('modal-close').addEventListener('click', hideModal);
    modalEl.addEventListener('click', (e) => {
      if (e.target === modalEl) hideModal();
    });

    document.getElementById('delete-btn').addEventListener('click', () => {
      if (selectedAssetId) deleteAsset(selectedAssetId);
    });

    document.getElementById('copy-ref-btn').addEventListener('click', () => {
      if (selectedAssetId) copyReference(selectedAssetId);
    });

    // Copy syntax click
    modalBody.addEventListener('click', (e) => {
      if (e.target.id === 'copy-syntax') {
        copyReference(selectedAssetId);
      }
      // Reference chip clicks
      const chip = e.target.closest('.ref-chip');
      if (chip) {
        navigateToRecord(chip.dataset.type, chip.dataset.id);
      }
    });

    // Export/Import
    document.getElementById('export-btn').addEventListener('click', exportAllAssets);
    document.getElementById('import-btn').addEventListener('click', importAssets);

    // Registry changes
    Registry.subscribe(() => render());

    // ============================================
    // Init
    // ============================================

    // Init omnibar (assets can't be created via search, but can navigate)
    Omnibar.init({
      app: 'assets',
      onCreate: null, // Assets require file upload
      onSelect: null  // Let omnibar handle navigation
    });

    render();
  </script>
</body>
</html>
